version: 2.1

orbs:
  node: circleci/node@4.0.1
  
  
references:
  custom_checkout: &custom_checkout
    name: Custom checkout
    command: |
      # Add GitHub to known hosts.
      mkdir -p ~/.ssh
      echo 'github.com,13.250.177.223 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==' >> ~/.ssh/known_hosts
      git clone --depth 1 "$CIRCLE_REPOSITORY_URL" --branch "$CIRCLE_BRANCH" .

jobs:
  static-checks:
    executor:
      name: node/default
      tag: '12.18.4'
    steps:
      - run: *custom_checkout
      - node/install-packages
      - run:
          name: Format Checking
          command: npm run format:check
      - run:
          name: Linting
          command: npm run lint

  unit-tests:
    executor:
      name: node/default
      tag: '12.18.4'
    steps:
      - run: *custom_checkout
      - node/install-packages
      - run:
          name: Unit Testing
          command: npm run test:unit -- -- --ci --maxWorkers 2

  integration-e2e:
    executor:
      name: node/default
      tag: '12.18.4'
    steps:
      - run: *custom_checkout
      - node/install-packages
      # Adapted from https://circleci.com/orbs/registry/orb/threetreeslight/puppeteer. Not using this Orb directly to
      # prevent re-downloading Chromium which was already done in the build step.
      # We only run this step here rather than in the build job because Chrome isn't needed for the other jobs.
      # Ideally, we'd use an image/executor that already have these dependencies, but that's not supported yet.
      # See https://discuss.circleci.com/t/new-ruby-convenience-image-public-beta/33274/6
      - run:
          name: Install Headless Chrome Dependencies
          command: |
            sudo apt update -qq
            sudo apt install -yqq \
              ca-certificates \
              fonts-liberation \
              gconf-service \
              libappindicator1 \
              libasound2 \
              libatk1.0-0 \
              libatk-bridge2.0-0 \
              libc6 \
              libcairo2 \
              libcups2 \
              libdbus-1-3 \
              libexpat1 \
              libfontconfig1 \
              libgbm-dev \
              libgcc1 \
              libgconf-2-4 \
              libgdk-pixbuf2.0-0 \
              libglib2.0-0 \
              libgtk-3-0 \
              libnspr4 \
              libnss3 \
              libpango-1.0-0 \
              libpangocairo-1.0-0 \
              libstdc++6 \
              libx11-6 \
              libx11-xcb1 \
              libxcb1 \
              libxcomposite1 \
              libxcursor1 \
              libxdamage1 \
              libxext6 \
              libxfixes3 \
              libxi6 \
              libxrandr2 \
              libxrender1 \
              libxss1 \
              libxtst6 \
              lsb-release \
              xdg-utils \
              wget
      - run:
          name: Configure local host mapping
          command: echo 127.0.0.1 a8c-abacus-local | sudo tee -a /etc/hosts
      - run:
          name: Integration Testing
          command: npm run test:integration -- --ci
      - run:
          name: End-to-End Testing
          command: GENERATE_SOURCEMAP=false npm run test:e2e -- --ci

workflows:
  build-and-test:
    jobs:
      - static-checks
      - unit-tests
      # Disabled until the SwaggerHub issue is fixed. See https://github.com/Automattic/abacus/issues/506.
      # - integration-e2e
